name: Convert CakePHP Documentation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      pandoc_version:
        description: 'Pandoc version'
        required: false
        default: '3.8.3' # Seems like < 3.3 is not working for us, especially for tables.
        type: string
      force_sync:
        description: 'Force sync to docs-md repo'
        required: false
        default: false
        type: boolean

jobs:
  convert-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CI: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y rsync python3 parallel

        # Install pandoc (configurable version)
        PANDOC_VERSION="${{ github.event.inputs.pandoc_version || '3.3' }}"
        echo "Installing Pandoc version: $PANDOC_VERSION"
        wget https://github.com/jgm/pandoc/releases/download/${PANDOC_VERSION}/pandoc-${PANDOC_VERSION}-linux-amd64.tar.gz
        tar xzf pandoc-${PANDOC_VERSION}-linux-amd64.tar.gz
        sudo cp pandoc-${PANDOC_VERSION}/bin/pandoc /usr/local/bin/

        # Verify installations
        pandoc --version
        python3 --version

    - name: Set up Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Make convert_branches executable
      run: chmod +x ./convert_branches

    - name: Run documentation conversion
      run: ./convert_branches --quiet

    - name: Clean up temp files and check for changes
      id: check_changes
      run: |
        # Remove any temp directories that might have been created
        find docs/ -name "temp" -type d -exec rm -rf {} + 2>/dev/null || true
        find docs/ -name "*.tmp" -type f -delete 2>/dev/null || true

        if [ -n "$(git status --porcelain docs/)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in docs/ folder"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in docs/ folder"
        fi

    - name: Commit and push changes to source repo
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git add docs/
        git commit -m "Update documentation from CakePHP docs branches

        ü§ñ Generated with GitHub Actions

        Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
        git push

    - name: Sync to docs-md repository
      if: steps.check_changes.outputs.changes == 'true' || github.event.inputs.force_sync == 'true'
      env:
        DOCS_MD_TOKEN: ${{ secrets.DOCS_MD_TOKEN }}
      run: |
        # Configure git to use the token for authentication
        git config --global url."https://x-access-token:${DOCS_MD_TOKEN}@github.com/".insteadOf "git@github.com:"

        # Track which branches were updated
        UPDATED_BRANCHES=""
        SKIPPED_BRANCHES=""

        # Process each version
        for VERSION in 2 3 4 5; do
          BRANCH="${VERSION}.x"
          LOCAL_EN_DIR="docs/${VERSION}.x"
          LOCAL_JA_DIR="docs/ja/${VERSION}.x"

          echo "=================================================="
          echo "Processing version ${VERSION}.x"
          echo "=================================================="

          # Check if we have docs for this version
          if [ ! -d "$LOCAL_EN_DIR" ] && [ ! -d "$LOCAL_JA_DIR" ]; then
            echo "‚ö†Ô∏è  No docs found for version ${VERSION}.x, skipping..."
            SKIPPED_BRANCHES="${SKIPPED_BRANCHES} ${BRANCH}"
            continue
          fi

          # Create a temporary directory for this branch
          TEMP_DIR="temp_docs_md_${VERSION}"
          rm -rf "$TEMP_DIR"
          mkdir -p "$TEMP_DIR"

          # Clone the specific branch (shallow clone for efficiency)
          echo "Cloning docs-md repository branch ${BRANCH}..."
          if ! git clone --depth 1 --branch "$BRANCH" "https://x-access-token:${DOCS_MD_TOKEN}@github.com/cakephp/docs-md.git" "$TEMP_DIR" 2>/dev/null; then
            echo "‚ö†Ô∏è  Branch ${BRANCH} not found in docs-md repository, skipping..."
            SKIPPED_BRANCHES="${SKIPPED_BRANCHES} ${BRANCH}"
            rm -rf "$TEMP_DIR"
            continue
          fi

          cd "$TEMP_DIR"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Ensure docs directories exist
          mkdir -p docs/en docs/ja

          # Define files to preserve in target repository (add your custom files here)
          # These files will NOT be deleted even if they don't exist in source
          PRESERVE_FILES=(
            "README.md"
            "CUSTOM.md"
            "index-new.md"
            # Add more files to preserve as needed
          )

          # Build rsync exclude arguments
          RSYNC_EXCLUDES="--exclude='.git*'"
          for file in "${PRESERVE_FILES[@]}"; do
            RSYNC_EXCLUDES="$RSYNC_EXCLUDES --exclude='$file'"
          done

          # Copy English docs if they exist
          if [ -d "../${LOCAL_EN_DIR}" ]; then
            echo "Copying English docs from ${LOCAL_EN_DIR}..."
            # Use --delete to remove files not in source, but preserve excluded files
            eval rsync -av --delete $RSYNC_EXCLUDES "../${LOCAL_EN_DIR}/" docs/en/
          else
            echo "No English docs found for version ${VERSION}.x"
          fi

          # Copy Japanese docs if they exist
          if [ -d "../${LOCAL_JA_DIR}" ]; then
            echo "Copying Japanese docs from ${LOCAL_JA_DIR}..."
            # Use --delete to remove files not in source, but preserve excluded files
            eval rsync -av --delete $RSYNC_EXCLUDES "../${LOCAL_JA_DIR}/" docs/ja/
          else
            echo "No Japanese docs found for version ${VERSION}.x"
          fi

          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected, committing to ${BRANCH}..."
            git add .
            git commit -m "Update documentation for ${BRANCH}

        ü§ñ Generated with GitHub Actions from $(date -u +'%Y-%m-%d %H:%M:%S UTC')

        Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

            echo "Pushing to ${BRANCH}..."
            git push origin "$BRANCH"
            echo "‚úÖ Successfully updated ${BRANCH}"
            UPDATED_BRANCHES="${UPDATED_BRANCHES} ${BRANCH}"
          else
            echo "‚ÑπÔ∏è  No changes for ${BRANCH}, skipping commit"
            SKIPPED_BRANCHES="${SKIPPED_BRANCHES} ${BRANCH}"
          fi

          # Return to root directory and cleanup
          cd ..
          rm -rf "$TEMP_DIR"

          echo ""
        done

        # Store results for summary
        echo "updated_branches=${UPDATED_BRANCHES}" >> $GITHUB_ENV
        echo "skipped_branches=${SKIPPED_BRANCHES}" >> $GITHUB_ENV

    - name: Create summary
      if: always()
      run: |
        echo "## Documentation Conversion Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "### ‚úÖ Documentation Conversion" >> $GITHUB_STEP_SUMMARY
          echo "Documentation updated successfully in source repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ÑπÔ∏è Documentation Conversion" >> $GITHUB_STEP_SUMMARY
          echo "No changes detected - documentation is up to date" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ] || [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
          echo "### üì¶ Sync to docs-md Repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ env.updated_branches }}" ]; then
            echo "**Updated branches:**${{ env.updated_branches }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ env.skipped_branches }}" ]; then
            echo "**Skipped branches (no changes):**${{ env.skipped_branches }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Generated at $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
